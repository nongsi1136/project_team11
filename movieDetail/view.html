<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atcha</title>
    <link rel="stylesheet" href="detail.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
  </head>

<body>
  <header class="Header">
    <!-- 헤더 왼쪽 몰기-->
    <div class="headerLeft">
      <h1 class="headerContainer">Atcha Pedia</h1>
      <nav class="headerContainer">
        <ul class="headerItem">
          <li class="headerItemlist"><a href="#">영화</a></li>
          <li class="headerItemlist"><a href="#">시리즈</a></li>
          <li class="headerItemlist"><a href="#">장르</a></li>
        </ul>
      </nav>
    </div>


    <!-- 헤더 오른쪽 몰기-->
    <div class="HeaderRight">
      <nav class="headerContainer">
        <ul class="headerItem">
          <li class="headerItemlist">
            <input type="text" placeholder="이 곳에 영화를 검색 해보세요 !" />
          </li>
          <li class="headerItemlist"><button>검색</button></li>
          <li class="headerItemlist"><a href="#">로그인</a></li>
          <li class="headerItemlist"><a href="#">회원 가입</a></li>
        </ul>
      </nav>
    </div>
  </header>


  <section id="movieWrapper">
    
  </section>

  <!-- 출연/ 제작 카드 리스트 -->
  <section>
    <div>
      <div class="Cast">
        <h2>제작/출연자</h2>
      </div>
    </div>
    <div class="cast-all" id="castWrapper">
      
    </div>
  </section>


  <!-- 코멘트 카드 리스트-->
  <section>
    <!-- 아이디/비밀번호/리뷰 등록창-->
    <div>
      <div class="Idpw">
        <p>아이디 : <input type="text" id="userID" placeholder="6~10자리로 입력해 주세요." /></p>
        <p>비밀번호 : <input type="text" id="userPW" placeholder="4자리 숫자로 입력해 주세요." /></p>
      </div>

      <!-- 별점 -->
      <!-- <span> -->
      <div class="Ment">
        <legend>당신의 별점은?</legend>
      </div>
      <!-- 별점 체크 -->
      <div class="Star">
        <input type="radio" name="reviewStar" value="★" id="rate1" /><label for="rate1">★</label>
        <input type="radio" name="reviewStar" value="★★" id="rate2" /><label for="rate2">★★</label>
        <input type="radio" name="reviewStar" value="★★★" id="rate3" /><label for="rate3">★★★</label>
        <input type="radio" name="reviewStar" value="★★★★" id="rate4" /><label for="rate4">★★★★</label>
        <input type="radio" name="reviewStar" value="★★★★★" id="rate5" /><label for="rate5">★★★★★</label>
      </div>

      <!-- 코멘트 입력 -->
      <p>
        감상 :
        <input
          type="text"
          class="inputComment"
          id="userRV"
          placeholder="여러분의 감상을 남겨주세요 !(50자 이상, 1,000자 이하)"
        />
      </p>

      <!-- 최종 -->
      <p><button id="ToWriteButton">등록하기/수정하기</button></p>
      <p><button id="ToDeleteButton">삭제하기</button></p>
      <!-- </span> -->

    <!-- 리뷰카드 리스트 -->
    <div class="commentList" id="comment-all-container"></div>
  </section>


    <!-- 바닥글 -->
    <footer class="foot">
      <nav class="footCcontainer">
        <li class="footItem"><a href="../index.html">홈으로</a></li>
        <li class="footItem">고객 센터</li>
        <li class="footItem">문의 하기</li>
      </nav>
      <p>Copyright © 2024 Node.js_4기 2주차 11조 All rights reserved.</p>
      <address>Contact webmaster for more information. https://github.com/ooommma/team11</address>
    </footer>
    
    <script src="view.js"></script>
    <script type="module">
      //유효성 검사 함수 import
      import {validationCheckID, validationCheckPW, validationCheckStars, validationCheckRV} from './validationCheck.js'

      let myMap = new Map();

      //리뷰 작성 함수
      function creatingReview() {
        //함수 내 변수 선언
        let id = document.querySelector("#userID").value;
        let password = document.getElementById("userPW").value;
        let selectedStars = document.querySelector('input[name="reviewStar"]:checked')
        //null 값 체크
        let stars = selectedStars ? selectedStars.value : String(false)
        let review = document.getElementById("userRV").value;

        //유효성 검사(id > password > review 순으로 진행됨)
  if(validationCheckID(id) === false) {
          return;
        } else if(validationCheckPW(password) === false) {
          return;
          } else if(validationCheckStars(stars) === false) {
            return;  
          } else if(validationCheckRV(review) === false) {
              return;
          };

          //유효성 검사를 통과한 데이터를 객체형태로 수집

          //1. 텍스트박스에 입력된 데이터가 myMap 자료구조에 각각의 키로 저장되도록 유도

        myMap.set(id, {"name": id, "password": password, "stars": stars})

        let forMergingRV = {"review": review}

        let MergedId = JSON.stringify({...myMap.get(id), ...forMergingRV});
        console.log(MergedId);

        //myMap 자료구조에 저장된 값을 로컬 스토리지로 이동하여 저장
        localStorage.setItem(id, MergedId);

        document.querySelector("#userID").value = "";
        document.getElementById("userPW").value = "";
        document.getElementById("userRV").value = "";
        location.reload();
      }

      function gettingReview() {
        document.querySelector('.commentList').innerHTML = "";
        for (let i = 0; i < localStorage.length; i++) {
          let key = localStorage.key(i);
          let result;
          let gettingValue;

          if(key !== null && key !== undefined) {
            result = localStorage.getItem(key);
            gettingValue = result;

            switch (key) {
            case null: 
            gettingValue = result;
            break;
            case undefined:
            gettingValue = result;
            break;
            default:
              try {
                gettingValue = JSON.parse(result);
              } catch(error) {
                console.error("Error parsing JSON", error);
              };
              break;
          };
          } else {
            console.log('오류: 해당 유저가 존재하지 않습니다.')
          };


          const temp_html = `
            <div class="comment-all">
                <div class="comment-container">
                      <div class="comment-items">
                        <div class="comment-ID">
                          <!-- gettingValue가 정의되지 않은 경우에 대한 처리 추가 -->
                          <div class="comment-item">ID ${gettingValue.name ? gettingValue.name : 'N/A'}</div>
                        <div class="comment-Info">
                          <div class="comment-item">별점 ${gettingValue.stars ? gettingValue.stars : 'N/A'}</div>
                          <div class="comment-item">코멘트 ${gettingValue.review ? gettingValue.review : 'N/A'}</div>
                        </div>
                      </div>
                  </div>
              </div>
        </div>
        `;
          document.querySelector(".commentList").innerHTML += temp_html;
        }
      }

      document.querySelector("#ToWriteButton").addEventListener("click", creatingReview);

      document.querySelector("#ToDeleteButton").addEventListener("click",  () => {
        const id = document.querySelector("#userID").value;
        const password = document.getElementById("userPW").value;
        if (
          JSON.parse(localStorage.getItem(id)).name === id &&
          JSON.parse(localStorage.getItem(id)).password === password
        ) {
          myMap.delete(id);
          localStorage.removeItem(id);
        }
        location.reload();
      });
      document.addEventListener("DOMContentLoaded", gettingReview);
    </script>
  </body>
</html>
